[hr]
[size=18][b][align=center]*** Лабораторная работа: мультисистемная флешка ***[/align][/b][/size]
[hr]
[img=right]https://libdepo.github.io/images/mlf0.png[/img]
[br]
[color=blue][b]Назначение проекта: [/b][/color][list=1]
[*]Подготовка флеш-накопителя для загрузки различных загрузчиков (BIOS/UEFI x64);
[*]Наполнение подготовленного флеш-накопителя дистрибутивами (Windows/Linux), сборками (загрузочными дисками), полезными утилитами.
[/list]
[br]
[color=blue][b]Представляет собой: [/b][/color][list]Набор командных бат-файлов и вспомогательных утилит.[/list]
[br]
[color=blue][b]Краткое описание принципа работы:[/b][/color]
[list=1]
[*]С помощью [i]diskpart[/i] размечает флешку;
[*]Форматирует в FAT32 без ограничений на размер раздела;
[*]Основным загрузчиком в MBR ставит [i]Xorboot 0.65[/i];[/list]
[spoiler=Важно!]
[th]https://libdepo.github.io/images/mlf1.gif[/th]
[br]
В стартовом меню [b]Xorboot[/b] на некоторых [i]BIOS[/i] могут не работать клавиши "вверх-вниз".
В этом случае выбор пунктов меню нужно производить через "горячие клавиши": [b]1-7[/b] и [b]P, R, S[/b].
[/spoiler]
[list=1]
[*=4]Помещает в корневую папку подготовленного флеш-накопителя командный бат-файл [b]zrun.cmd[/b], с помощью которого осуществляется дальнейшее управление проектом.
[/list]
[br]
[color=blue][b]Список загрузчиков:[/b][/color]
[list]
[*]Syslinux 6.03
[*]Syslinux 4.07
[*]Bootmgr 10
[*]Bootmgr 7
[*]Grub4Dos 0.4.6
[*]Grub4Dos 0.4.5
[*]GRUB2 2.02
[/list]
[color=blue][b]Поддержка EFI SecureBoot:[/b][/color]
[list]Да[/list]
[spoiler=SecureBoot]
[list][*]Начальным загрузчиком стоит связка [i]preloader+grub2[/i] с ЦП KasperskyLab;
[*]Может быть заменён на связку [i]shim+grub2[/i] с ЦП Canonical или оригинальный от Microsoft Corp., или «Диспетчер UEFI-загрузчиков»;
[*]Также реализована возможность загрузки в режиме SecureBoot самоподписанного [i]grub2[/i] по [url=https://habr.com/ru/post/446072/]методу ValdikSS[/url] (требует ручной установки ЦП; см. «Управление загрузчиками»)
[/list][/spoiler]
[br]
[spoiler=Дополнительно]
Папка с дополнительными утилитами [b]\boot\boot\utils[/b]:
[list]
[*]компилятор загрузчика [b]grub2[/b] (можно собрать ядро со своими модулями и своим конфигом)
[*]комплект [b]xorboot[/b] (сам установщик и мой модуль - можно перекроить и на флешку вбить)
[*]комплект [b]wimboot[/b] с примерами для загрузчиков [i]g4d[/i], [i]grub2[/i], [i]syslinux[/i].
[/list][/spoiler]

[spoiler=Управление]
[br]
Файл [b]zrun.cmd[/b] в корне созданной флешки - это [i]Панель управления *** Multi-loader flash ***[/i]. При запуске предлагает меню из четырёх пунктов:
[list][*]Управление дополнениями
[*]Управление загрузчиками
[*]Управление конфигурациями ("ручная" правка меню загрузчиков и их бэкап/восстановление ([color=red]не рекомендуется![/color])
[*]Управление доп.возможностями (работа с x-lets и бэкап)
[/list]
* В дальнейшем, количество пунктов может расти.
[br]
[align=center][b][size=16]Управление дополнениями[/size][/b][/align]
[br]
[i]Дополнение[/i] - это файл(-ы), расширяющий(-е) возможности и функционал проекта. Это могут быть загрузочные образы, сборки, набор программ и т.п.

Дополнение можно:
[list][*]установить
[*]удалить
[*]проверить целостность
[*]переустановить (= удалить + установить)[/list]

[u]Установка дополнения[/u]

Требует наличия сети Интернет, откуда происходит скачивание дополнения.
[color=red]* Внимание![/color] Все операции по сохранению, распаковке, обработке происходят по пути [i]%TEMP%[/i]. Убедитесь, что там достаточно места.
[br]
Процесс: загружаются нужные файлы, вычисляется CRC32 для каждого, файлы переписываются на флешку. Если необходимо, добавляются пункты меню в меню соответствующих загрузчиков.

[u]Удаление дополнения[/u]

Процесс: удаляются файлы дополнения с флешки. Если необходимо, удаляются пункты меню из меню соответствующих загрузчиков.

[u]Проверка целостности[/u]

Позволяет отследить порчу/удаление файлов дополнения из-за деградации флешки, действий вирусов/антивирусов, перекрытия файлов дополнения другими файлами.

Процесс: согласно созданному при добавлении дополнения списку CRC32, проверяются файлы дополнения.

[u]Переустановка дополнения[/u]

Удаляет и заново устанавливает дополнение. Обычно используется для обновления дополнения.
* Сама система также является дополнением (System Core) и может быть обновлена переустановкой.
[br]
[align=center][b][size=16]Управление загрузчиками[/size][/b][/align]
[br]
[u]Загрузчик BIOS[/u]

Основным загрузчиком является [b]Xorboot 0.65[/b]. Он записан в начальные сектора флешки и позволяет загружать все остальные загрузчики проекта. Существует возможность сменить Xorboot на:
[list][*] [b]GRUB2[/b] - полностью записывается в MBR. Загружает среду GRUB2.
[*] [b]Syslinux 6.03/4.07[/b] - оригинальные загрузчики MBR и PBR. Загружает среду Syslinux.
[*] [b]Wee63/127[/b] - полностью записывается в MBR. Позволяет загружать некоторые загрузчики и несжатые образы FDD.
[/list]

Существует возможность сразу (без меню выбора загрузчика) загружаться в среду Grub4Dos или BOOTMGR. Для этого нужно выбрать загрузчик из секции "MBR + BOOTLDR":

[list][*] [b]Grub4Dos[/b] - загрузчик MBR (PBR не используется).
[*] [b]USB-HDD+[/b] - стандартный загрузчик MBR с улучшенной поддержкой загрузки с флешки.
[*] [b]USB-ZIP+[/b] - загрузчик MBR, позволяющий эмулировать USB-ZIP устройство.
[/list]

После чего появится возможность выбора среды:
[list][*] Grub4Dos 0.4.6
[*] Grub4Dos 0.4.5
[*] BOOTMGR v.10
[*] BOOTMGR v.7
[/list]

[u]Примечание:[/u]
[list][*] менять загрузчик рекомендуется только в случае проблем с загружаемостью стандартного загрузчика проекта [b]Xorboot 0.65[/b]
[*] загрузчик [b]USB-ZIP+[/b] необратимо "смещает" рабочий раздел флешки hd0,0 -> hd0,3
[*] загрузчик MBR [b]Grub4Dos[/b] обладает высокой загружаемостью и рекомендуется в "сложных" случаях.
[*] загрузчик PBR (для MBR = USB-HDD+/USB-ZIP+) соответствует выбираемой среде G4D/BMGR
[/list]

[u]Загрузчик UEFI[/u]

Существует возможность выбора начального загрузчика для UEFI режима. Это:

[list][*] связка preloader + grub2 с ЦП от Kaspersky (по умолчанию)
[*] связка shim + grub2 с ЦП от Canonical
[*] комплект от [b]ValdikSS[/b] для обхода SecureBoot (preloader выставляет политику "разрешить всё")
[*] Windows Boot Manager
[*] «Диспетчер UEFI-загрузчиков» (при запуске позволяет выбрать загрузчик из перечисленных выше)
[/list]
[spoiler=Как использовать метод «обход SecureBoot»]
[th]https://libdepo.github.io/images/mlf2.gif[/th]
[/spoiler]
[br]
Можно менять версию используемого Windows Boot Manager: 10 (по умолчанию) или 7
Выбранная версия WBM будет грузиться:
[list][*] как самостоятельный загрузчик bootx64.efi (при выборе WBM в качестве начального)
[*] из меню GRUB2 (для загрузки WIM-ядер)
[/list]
[/spoiler]

[spoiler=Работа с образами]
[br]
Загрузчик Grub4Dos позволяет выполнять динамическую загрузку образов дисков. Папка [b]\images[/b] в корне флешки используется для такого рода загрузки.

[u]Порядок действий:[/u]
[list][*] скопировать образ в соответствующую подпапку (см. ниже)
[*] в основном меню Grub4Dos нажать клавишу "[color=red][b]L[/b][/color]"
[/list]

[u]Поддерживается работа с:[/u]
[list][*] образы FDD/HDD
[*] образы CD/DVD
[*] загрузочные образы WIM
[*] конфиги Grub4Dos
[*] конфиги BCD
[/list]

[u]Назначение подпапок:[/u]
[list][*] [b]BCD:[/b][tab][tab]конфиги BCD
[*] [b]CONFIG:[/b][tab]конфиги Grub4Dos
[*] [b]EFI:[/b][tab][tab]efilets (см. ниже)
[*] [b]FLOPPY:[/b][tab]образы дисков без MBR (FDD)
[*] [b]HDD:[/b][tab][tab]образы дисков с MBR (HDD)
[*] [b]ISO:[/b][tab][tab]образы CD/DVD
[*] [b]LINUX:[/b][tab]образы CD/DVD маппируются в раздел (hd0,2). Образ должен быть дефрагментирован.
[*] [b]WIM:[/b][tab][tab]загрузочные образы WIM
[/list]

[u]Загрузка образов[/u]

При загрузке образов FDD/HDD/ISO предлагаются варианты:
[list][*] подождать 10 сек или нажать [i]Esc[/i]: прямая загрузка образа с флешки
[*] нажать [i]Enter[/i]: предварительная загрузка образа в память
[/list]
При загрузке образов WIM предлагаются варианты:
[list][*] подождать 10 сек или нажать [i]Esc[/i]: загрузка с помощью BOOTMGR ver.10
[*] нажать [i]Enter[/i]: загрузка с помощью BOOTMGR ver.7 (позволяет обходить проблемы с цифровыми подписями)
[/list]

[u]Работа с efilets[/u]

Папка [b]\images\EFI[/b] может содержать:
[list][*]файлы с расширением .EFI (будут добавлены как пользовательские утилиты)
[*]текстовые файлы (будут добавлены как пользовательские меню GRUB2)
[*]подпапки
[/list]

Каждая подпапка должна содержать или:
[list][*]файл BCD (в подпапку будет автоматически скопирован системный bootx64.efi)[/list]
или
[list][*]файл bootx64.efi со вспомогательными файлами и подпапками[/list]

Для создания/обновления efilets в «Панели управления» (zrun.cmd) выбрать «Управление доп.возможностями» → «Обновление efilets»

* Примечания:
[list][*]авторский BCD обычно расположен в папке \EFI\MICROSOFT\BOOT\
[*]в подпапку с файлом BCD можно скопировать авторский bootx64.efi вместе с файлом(-ами) оформления .MUI в соответствующих подпапках
[*]в подпапку можно скопировать содержимое авторской папки \EFI\BOOT\ (таким образом можно добавить, например, загрузку авторского rEFInd)
[/list]

[u]Специальные пункты меню[/u]

Пункт меню: [b]Load images by MEMDISK...  >[/b]

На некоторых BIOS загрузка образов средствами Grub4Dos не работает. В этом случае можно использовать загрузку образов через утилиту MEMDISK

Пункт меню: [b]LINUX: clean (hd0,2)[/b]

Очистить раздел (hd0,2) после маппирования в него ISO-образа.

Пункт меню: [b]Load images by swap FLOPPY/HDD, ISO/LINUX...  >[/b]

Попробовать загрузить образ(-ы) из папки FLOPPY (образ без MBR) как HDD (образ с MBR) и наоборот.
Попробовать загрузить образ(-ы) из папки ISO (может быть фрагментирован) как LINUX раздел диска (должен быть непрерывным) и наоборот.

Полезно, если изначально способ работы с образом был выбран неверно.

* Примечания:
[list][*] Имя и расширение файла образа может быть любым (без пробелов и русских букв). Зарезервировано только [i]readme.txt[/i]
[*] Образы FDD/HDD/ISO могут быть сжаты в GZ
[*] Ограничения Grub4Dos 0.4.5:
[list][*] при прямой загрузке с флешки требует дефрагментации образа
[*] не работает с образами WIM
[/list]
[/list]

[u]Советы:[/u]
Для загрузки сторонней сборки, если она использует в качестве загрузчика Grub4Dos, можно поместить menu.lst этой сборки в папку \images\CONFIG
Для загрузки сторонней сборки, если она использует в качестве загрузчика BOOTMGR, можно поместить BCD этой сборки в папку \images\BCD

[/spoiler]
[spoiler=Работа с x-lets]
[align=center][b][size=16]Создание wimlets[/size][/b][/align]
[br]
Образы из папки [b]\images\WIM[/b] можно добавить в основное меню загрузчиков без создания дополнения. Порядок действий:
[list]
[*] Скопировать загрузочный образ WIM в папку [b]\images\WIM[/b]
[*] Выполнить «Панель управления» (zrun.cmd) → «Управление доп.возможностями» → «Обновление wimlets»
[*] Согласиться с добавлением образа в загрузочное меню
[*] Ввести название пункта меню
[/list]
[br]
Для удаления образа из основного меню загрузчиков:
[list][*] Удалить образ WIM из папки [b]\images\WIM[/b]
[*] Выполнить «Панель управления» (zrun.cmd) → «Управление доп.возможностями» → «Обновление wimlets»
[/list]
[br]
* Примечания:
[list][*] образ WIM не должен содержать в названии пробелов и не-английских букв, должен иметь расширение .wim
[*] образ будет добавлен в меню Windows Boot Manager [b]UEFI[/b] только в том случае, если образ поддерживает разрядность х64
[*] название меню можно вводить по-русски, но в меню GRUB2 будут отображаться знаки ??? вместо русских букв
[/list]

[hr]

[align=center][b][size=16]Создание vhdlets[/size][/b][/align]
[br]
Можно добавлять в загрузку VHD-контейнеры. Поскольку для работы требуется NTFS, то располагаться VHD должны на сторонних разделах/дисках, которые будут присутствовать при загрузке MLF.

Порядок действий:
[list]
[*] Выполнить «Панель управления» (zrun.cmd) → «Управление доп.возможностями» → «Обновление vhdlets»
[*] Выбрать VHD на стороннем разделе/диске
[*] Ввести название пункта меню[/list]

Для удаления пункта меню:
[list]
[*] Удалить/переименовать VHD или отключить раздел/диск, на котором он расположен
[*] Выполнить «Панель управления» (zrun.cmd) → «Управление доп.возможностями» → «Обновление vhdlets»
[*] Согласиться с удалением[/list]

* Примечания:
[list]
[*] выбор контейнера реализован через командлет powershell, он запускается довольно медленно, не паниковать
[*] в меню UEFI добавляются только контейнеры с поддержкой х64
[*] если при загрузке MLF раздел/диск с контейнером VHD будет недоступен, то BOOTMGR v7 будет вылетать с ошибкой, а BOOTMGR v10 не покажет пунктов меню с загрузкой VHD[/list]

[br]
[b]Пример работы с vhdlet:[/b]
[list]
[*] берём HDD в USB-Box
[*] устанавливаем MLF и аддон BootItBM (сейчас является частью аддона «TeraByte Software Suite»)
[*] загружаемся с него, с помощью BootItBM сжимаем первый раздел, на свободном месте создаём раздел NTFS
[*] загружаемся в нормальную винду, переписываем на раздел NTFS контейнер(-ы) VHD в произвольную папку(-и)
[*] выполняем инструкцию по добавлению
[/list]

[hr]

[align=center][b][size=16]Управление efilets[/size][/b][/align]
[br]
Работа с [i]efilets[/i] рассмотрена в разделе «Работа с образами»

[hr]

[align=center][b][size=16]Управление addlets[/size][/b][/align]
[br]
[i]Addlet[/i] - это ещё один способ (наряду с [i]Дополнениями[/i]) расширить возможности и функционал проекта. С помощью [i]addlets[/i] можно загрузить утилиты, установочные дистрибутивы, наборы ПО, дистрибутивы Windows; зайти на интернет-ресурсы для самостоятельной загрузки необходимого ПО.
Как правило, загрузка происходит в папку [b]\programs[/b]. Исключения:
[list][*]набор драйверов SDI записывается в папку [b]\drivers[/b]
[*]дистрибутивы Windows записываются в папку [b]\distros[/b].
[/list]

В отличии от  [i]Дополнений[/i], [i]addlets[/i] только скачивают и записывают ПО на флеш-носитель, но не позволяют управлять им в дальнейшем (то есть задачи контроля целостности информации и её удаления возлагаются на самого пользователя).

Функционал [i]addlets[/i] выделен в отдельный модуль, который динамически подгружается из сети интернет. Поэтому расширение списка ПО, доступного для записи на флешку с помощью механизма [i]addlets[/i], происходит без необходимости обновления всего проекта.

* Примечания:
[list][*]ПО, уже записанное на флешку (если это не ссылка на интернет-страницу ), помечается знаком «[b]*[/b]» перед названием соответствующего [i]addlet[/i]
[*]ПО, которое скачивается непосредственно с сайта производителя, помечается как «[b]online[/b]»; в остальных случаях приводится текущая версия
[/list]
[/spoiler]
[spoiler=Бэкап: создание/восстановление]
[align=center][b][size=16]Бэкап: создание/восстановление[/size][/b][/align]
[br]
[u]Создание[/u]
[br]
Выполнить «Панель управления» (zrun.cmd) → «Управление доп.возможностями» → «Создать резервную копию»

По умолчанию создаётся [b]C:\mlf_backup.wim[/b] (можно в окне 7zG изменить путь и параметры архивации). По сути, просто создание архива всей флешки. Можно делать и самому, вручную.

Формат:[tab]любой из поддерживаемых 7z (7z, ZIP, RAR, WIM, ISO, GZ и т. п.)
Имя:[tab][tab]mlf_backup.* (расширение может быть любым, в т.ч. нестандартным. Например: mlf_backup.maximum, mlf_backup.01_04_2019 и т.п.)

[u]Восстановление:[/u]
[list=1]
[*]Поместить архив/образ mlf_backup.* рядом с PrepFlash.cmd
[*]Запустить PrepFlash.cmd и выбрать флеш-накопитель
[*]После разметки флешки согласиться на восстановление из резервной копии. При этом:
[list]
[*]архив будет развёрнут на флешку
[*]удалён аддон System Core
[*]установлен аддон System Core без обращения в Интернет.
[/list][/list]
[br]
Таким образом, для подготовки флешки нужны только два файла: [b]system.7z[/b] (сама система MLF) и файл бекапа [b]mlf_backup.*[/b] ранее созданной флешки со всеми аддонами и нужным ПО.
[/spoiler]
[br]
[spoiler=ЧаВо]
В: Установил дополнение Х, но в режиме UEFI нет загрузки ядра(-ер) Windows. Почему?
О: Для запуска ядер Windows из загрузчика GRUB2 (в режиме UEFI) выберите пункт меню "[b]Windows Boot Manager...[tab]>[/b]"
[/spoiler]
[spoiler=Благодарности]
[b]dimo70[/b], [b]apostol[/b], [b]goga8686[/b] за активное тестирование и выявление всякого.
[b]vovan1982[/b], [b]AZJIO[/b] за файл справки о проекте.
[/spoiler]
[spoiler=Видео-инструкции (MP4)][list]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Create.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Создать загрузочную флешку с MLF[/url]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Simple.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Создать простейший загрузочный комплект[/url]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Add2k10.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Добавить сборку (загрузочный диск)[/url]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/AddSoft.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Добавить полезные утилиты[/url]
[hr]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Addons.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Управление дополнениями[/url]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Loaders.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Управление загрузчиками[/url]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Configs.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Управление конфигурациями[/url]
[hr]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Linux.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Добавить дистрибутив Linux[/url]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/Windows.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Добавить дистрибутив Windows[/url]
[hr]
[url=https://yadi.sk/d/zA_iWURL_BntWQ/Video.MLF/VHD.mp4][img]https://libdepo.github.io/images/mlf3.png[/img]  Создать раздел NTFS и разместить там VHD-контейнер [size=9](для USB-HDD)[/size][/url]
[/list][/spoiler]
[align=right][url=https://libdepo.github.io/misc/mlf_history.txt][size=9][журнал][/size][/url][/align]
[align=center][url=https://cloud.mail.ru/public/2S5M/3LqwxL8nZ]Загрузить[img]https://libdepo.github.io/images/download.png[/img][/url][/align]